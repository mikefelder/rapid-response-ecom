{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "4544944985634613977"
    }
  },
  "parameters": {
    "environment": {
      "type": "string",
      "defaultValue": "dev",
      "allowedValues": [
        "dev",
        "prod"
      ],
      "metadata": {
        "description": "Environment name (e.g., dev, prod)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "southcentralus",
      "metadata": {
        "description": "Azure region for resource deployment"
      }
    },
    "baseName": {
      "type": "string",
      "defaultValue": "rrshopper",
      "minLength": 3,
      "maxLength": 16,
      "metadata": {
        "description": "Base name for all resources"
      }
    },
    "smsPhoneNumber": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Phone number for SMS notifications in E.164 format"
      }
    },
    "bestBuyApiKey": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Best Buy API key for inventory checks"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "project": "rapid-response-shopper",
        "environment": "[parameters('environment')]",
        "managedBy": "bicep"
      },
      "metadata": {
        "description": "Tags to apply to all resources"
      }
    }
  },
  "variables": {
    "resourceGroupName": "[format('rg-{0}-{1}', parameters('baseName'), parameters('environment'))]",
    "uniqueSuffix": "[uniqueString(subscription().subscriptionId, parameters('baseName'), parameters('environment'))]"
  },
  "resources": {
    "resourceGroup": {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2024-03-01",
      "name": "[variables('resourceGroupName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]"
    },
    "logAnalytics": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('logAnalytics-{0}', uniqueString('logAnalytics', deployment().name))]",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "baseName": {
            "value": "[parameters('baseName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "1061981354177519889"
            }
          },
          "parameters": {
            "baseName": {
              "type": "string",
              "metadata": {
                "description": "Base name for resources"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[format('log-{0}-{1}', parameters('baseName'), parameters('environment'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30,
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                },
                "workspaceCapping": {
                  "dailyQuotaGb": 1
                }
              }
            }
          ],
          "outputs": {
            "workspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace resource ID"
              },
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', format('log-{0}-{1}', parameters('baseName'), parameters('environment')))]"
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace name"
              },
              "value": "[format('log-{0}-{1}', parameters('baseName'), parameters('environment'))]"
            }
          }
        }
      },
      "dependsOn": [
        "resourceGroup"
      ]
    },
    "appInsights": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('appInsights-{0}', uniqueString('appInsights', deployment().name))]",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "baseName": {
            "value": "[parameters('baseName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference('logAnalytics').outputs.workspaceId.value]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "15244264800178487209"
            }
          },
          "parameters": {
            "baseName": {
              "type": "string",
              "metadata": {
                "description": "Base name for resources"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace resource ID"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[format('appi-{0}-{1}', parameters('baseName'), parameters('environment'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[parameters('logAnalyticsWorkspaceId')]",
                "IngestionMode": "LogAnalytics",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled",
                "RetentionInDays": 30
              }
            }
          ],
          "outputs": {
            "connectionString": {
              "type": "string",
              "metadata": {
                "description": "Application Insights connection string"
              },
              "value": "[reference(resourceId('Microsoft.Insights/components', format('appi-{0}-{1}', parameters('baseName'), parameters('environment'))), '2020-02-02').ConnectionString]"
            },
            "instrumentationKey": {
              "type": "string",
              "metadata": {
                "description": "Application Insights instrumentation key"
              },
              "value": "[reference(resourceId('Microsoft.Insights/components', format('appi-{0}-{1}', parameters('baseName'), parameters('environment'))), '2020-02-02').InstrumentationKey]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "Application Insights resource ID"
              },
              "value": "[resourceId('Microsoft.Insights/components', format('appi-{0}-{1}', parameters('baseName'), parameters('environment')))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Application Insights name"
              },
              "value": "[format('appi-{0}-{1}', parameters('baseName'), parameters('environment'))]"
            }
          }
        }
      },
      "dependsOn": [
        "logAnalytics",
        "resourceGroup"
      ]
    },
    "keyVault": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('keyVault-{0}', uniqueString('keyVault', deployment().name))]",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "baseName": {
            "value": "[parameters('baseName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "uniqueSuffix": {
            "value": "[variables('uniqueSuffix')]"
          },
          "secrets": {
            "value": [
              {
                "name": "BestBuyApiKey",
                "value": "[parameters('bestBuyApiKey')]"
              },
              {
                "name": "SmsPhoneNumber",
                "value": "[parameters('smsPhoneNumber')]"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "8957206671434121548"
            }
          },
          "definitions": {
            "SecretConfig": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Secret name"
                  }
                },
                "value": {
                  "type": "string",
                  "metadata": {
                    "description": "Secret value"
                  }
                }
              },
              "additionalProperties": false,
              "metadata": {
                "description": "Secret configuration"
              }
            }
          },
          "parameters": {
            "baseName": {
              "type": "string",
              "metadata": {
                "description": "Base name for resources"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "uniqueSuffix": {
              "type": "string",
              "metadata": {
                "description": "Unique suffix for globally unique names"
              }
            },
            "secrets": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/SecretConfig"
              },
              "metadata": {
                "description": "Secrets to store in Key Vault"
              }
            }
          },
          "resources": {
            "keyVault": {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[format('kv{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "tenantId": "[subscription().tenantId]",
                "enableRbacAuthorization": true,
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": 7,
                "publicNetworkAccess": "Enabled",
                "networkAcls": {
                  "defaultAction": "Allow",
                  "bypass": "AzureServices"
                }
              }
            },
            "secretResources": {
              "copy": {
                "name": "secretResources",
                "count": "[length(parameters('secrets'))]"
              },
              "condition": "[not(empty(parameters('secrets')[copyIndex()].value))]",
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', format('kv{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix')), parameters('secrets')[copyIndex()].name)]",
              "properties": {
                "value": "[parameters('secrets')[copyIndex()].value]",
                "attributes": {
                  "enabled": true
                }
              },
              "dependsOn": [
                "keyVault"
              ]
            }
          },
          "outputs": {
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "Key Vault resource ID"
              },
              "value": "[resourceId('Microsoft.KeyVault/vaults', format('kv{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix')))]"
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name"
              },
              "value": "[format('kv{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix'))]"
            },
            "vaultUri": {
              "type": "string",
              "metadata": {
                "description": "Key Vault URI"
              },
              "value": "[reference('keyVault').vaultUri]"
            }
          }
        }
      },
      "dependsOn": [
        "resourceGroup"
      ]
    },
    "cosmosDb": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('cosmosDb-{0}', uniqueString('cosmosDb', deployment().name))]",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "baseName": {
            "value": "[parameters('baseName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "uniqueSuffix": {
            "value": "[variables('uniqueSuffix')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "12605444889214218101"
            }
          },
          "parameters": {
            "baseName": {
              "type": "string",
              "metadata": {
                "description": "Base name for resources"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "uniqueSuffix": {
              "type": "string",
              "metadata": {
                "description": "Unique suffix for globally unique names"
              }
            }
          },
          "variables": {
            "databaseName": "rapid-response-shopper",
            "containers": [
              {
                "name": "products",
                "partitionKey": "/id",
                "indexingPolicy": {
                  "automatic": true,
                  "indexingMode": "consistent",
                  "includedPaths": [
                    {
                      "path": "/*"
                    }
                  ],
                  "excludedPaths": [
                    {
                      "path": "/\"_etag\"/?"
                    }
                  ],
                  "compositeIndexes": [
                    [
                      {
                        "path": "/retailer",
                        "order": "ascending"
                      },
                      {
                        "path": "/isActive",
                        "order": "ascending"
                      },
                      {
                        "path": "/lastCheckedAt",
                        "order": "descending"
                      }
                    ]
                  ]
                },
                "defaultTtl": -1
              },
              {
                "name": "inventory-history",
                "partitionKey": "/productId",
                "indexingPolicy": {
                  "automatic": true,
                  "indexingMode": "consistent",
                  "includedPaths": [
                    {
                      "path": "/*"
                    }
                  ],
                  "excludedPaths": [
                    {
                      "path": "/\"_etag\"/?"
                    }
                  ],
                  "compositeIndexes": [
                    [
                      {
                        "path": "/productId",
                        "order": "ascending"
                      },
                      {
                        "path": "/timestamp",
                        "order": "descending"
                      }
                    ]
                  ]
                },
                "defaultTtl": 7776000
              },
              {
                "name": "user-preferences",
                "partitionKey": "/id",
                "indexingPolicy": {
                  "automatic": true,
                  "indexingMode": "consistent",
                  "includedPaths": [
                    {
                      "path": "/*"
                    }
                  ],
                  "excludedPaths": [
                    {
                      "path": "/\"_etag\"/?"
                    }
                  ]
                },
                "defaultTtl": -1
              }
            ]
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2024-05-15",
              "name": "[format('cosmos{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "GlobalDocumentDB",
              "properties": {
                "databaseAccountOfferType": "Standard",
                "capabilities": [
                  {
                    "name": "EnableServerless"
                  }
                ],
                "consistencyPolicy": {
                  "defaultConsistencyLevel": "Session"
                },
                "locations": [
                  {
                    "locationName": "[parameters('location')]",
                    "failoverPriority": 0,
                    "isZoneRedundant": false
                  }
                ],
                "publicNetworkAccess": "Enabled",
                "disableLocalAuth": false
              }
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
              "apiVersion": "2024-05-15",
              "name": "[format('{0}/{1}', format('cosmos{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix')), variables('databaseName'))]",
              "properties": {
                "resource": {
                  "id": "[variables('databaseName')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', format('cosmos{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix')))]"
              ]
            },
            {
              "copy": {
                "name": "cosmosContainers",
                "count": "[length(variables('containers'))]"
              },
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2024-05-15",
              "name": "[format('{0}/{1}/{2}', format('cosmos{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix')), variables('databaseName'), variables('containers')[copyIndex()].name)]",
              "properties": {
                "resource": {
                  "id": "[variables('containers')[copyIndex()].name]",
                  "partitionKey": {
                    "paths": [
                      "[variables('containers')[copyIndex()].partitionKey]"
                    ],
                    "kind": "Hash",
                    "version": 2
                  },
                  "indexingPolicy": "[variables('containers')[copyIndex()].indexingPolicy]",
                  "defaultTtl": "[variables('containers')[copyIndex()].defaultTtl]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', format('cosmos{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix')), variables('databaseName'))]"
              ]
            }
          ],
          "outputs": {
            "endpoint": {
              "type": "string",
              "metadata": {
                "description": "Cosmos DB account endpoint"
              },
              "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', format('cosmos{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix'))), '2024-05-15').documentEndpoint]"
            },
            "accountName": {
              "type": "string",
              "metadata": {
                "description": "Cosmos DB account name"
              },
              "value": "[format('cosmos{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix'))]"
            },
            "databaseName": {
              "type": "string",
              "metadata": {
                "description": "Cosmos DB database name"
              },
              "value": "[variables('databaseName')]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "Cosmos DB resource ID"
              },
              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts', format('cosmos{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix')))]"
            }
          }
        }
      },
      "dependsOn": [
        "resourceGroup"
      ]
    },
    "serviceBus": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('serviceBus-{0}', uniqueString('serviceBus', deployment().name))]",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "baseName": {
            "value": "[parameters('baseName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "uniqueSuffix": {
            "value": "[variables('uniqueSuffix')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "14244629234826169548"
            }
          },
          "parameters": {
            "baseName": {
              "type": "string",
              "metadata": {
                "description": "Base name for resources"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "uniqueSuffix": {
              "type": "string",
              "metadata": {
                "description": "Unique suffix for globally unique names"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ServiceBus/namespaces",
              "apiVersion": "2022-10-01-preview",
              "name": "[format('sb{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Basic",
                "tier": "Basic"
              },
              "properties": {
                "minimumTlsVersion": "1.2",
                "publicNetworkAccess": "Enabled",
                "disableLocalAuth": false
              }
            },
            {
              "type": "Microsoft.ServiceBus/namespaces/queues",
              "apiVersion": "2022-10-01-preview",
              "name": "[format('{0}/{1}', format('sb{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix')), 'inventory-events')]",
              "properties": {
                "maxDeliveryCount": 5,
                "lockDuration": "PT1M",
                "defaultMessageTimeToLive": "P1D",
                "deadLetteringOnMessageExpiration": true,
                "enablePartitioning": false,
                "maxSizeInMegabytes": 1024
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', format('sb{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.ServiceBus/namespaces/queues",
              "apiVersion": "2022-10-01-preview",
              "name": "[format('{0}/{1}', format('sb{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix')), 'notifications')]",
              "properties": {
                "maxDeliveryCount": 3,
                "lockDuration": "PT30S",
                "defaultMessageTimeToLive": "PT1H",
                "deadLetteringOnMessageExpiration": true,
                "enablePartitioning": false,
                "maxSizeInMegabytes": 1024
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', format('sb{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix')))]"
              ]
            }
          ],
          "outputs": {
            "namespaceName": {
              "type": "string",
              "metadata": {
                "description": "Service Bus namespace name"
              },
              "value": "[format('sb{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix'))]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "Service Bus namespace resource ID"
              },
              "value": "[resourceId('Microsoft.ServiceBus/namespaces', format('sb{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix')))]"
            },
            "endpoint": {
              "type": "string",
              "metadata": {
                "description": "Service Bus namespace endpoint"
              },
              "value": "[reference(resourceId('Microsoft.ServiceBus/namespaces', format('sb{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix'))), '2022-10-01-preview').serviceBusEndpoint]"
            },
            "inventoryEventsQueueName": {
              "type": "string",
              "metadata": {
                "description": "Inventory events queue name"
              },
              "value": "inventory-events"
            },
            "notificationsQueueName": {
              "type": "string",
              "metadata": {
                "description": "Notifications queue name"
              },
              "value": "notifications"
            }
          }
        }
      },
      "dependsOn": [
        "resourceGroup"
      ]
    },
    "communicationServices": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('communicationServices-{0}', uniqueString('communicationServices', deployment().name))]",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "baseName": {
            "value": "[parameters('baseName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "global"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "uniqueSuffix": {
            "value": "[variables('uniqueSuffix')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "10769273196352703548"
            }
          },
          "parameters": {
            "baseName": {
              "type": "string",
              "metadata": {
                "description": "Base name for resources"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region - ACS is a global service"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "uniqueSuffix": {
              "type": "string",
              "metadata": {
                "description": "Unique suffix for globally unique names"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Communication/communicationServices",
              "apiVersion": "2023-04-01",
              "name": "[format('acs{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "dataLocation": "United States"
              }
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Communication Services name"
              },
              "value": "[format('acs{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix'))]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "Communication Services resource ID"
              },
              "value": "[resourceId('Microsoft.Communication/communicationServices', format('acs{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix')))]"
            },
            "endpoint": {
              "type": "string",
              "metadata": {
                "description": "Communication Services endpoint"
              },
              "value": "[reference(resourceId('Microsoft.Communication/communicationServices', format('acs{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix'))), '2023-04-01').hostName]"
            }
          }
        }
      },
      "dependsOn": [
        "resourceGroup"
      ]
    },
    "storageAccount": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('storageAccount-{0}', uniqueString('storageAccount', deployment().name))]",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "baseName": {
            "value": "[parameters('baseName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "uniqueSuffix": {
            "value": "[variables('uniqueSuffix')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "3318526193295545155"
            }
          },
          "parameters": {
            "baseName": {
              "type": "string",
              "metadata": {
                "description": "Base name for resources"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "uniqueSuffix": {
              "type": "string",
              "metadata": {
                "description": "Unique suffix for globally unique names"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            }
          },
          "variables": {
            "storageAccountName": "[toLower(format('strrs{0}', take(parameters('uniqueSuffix'), 13)))]"
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-05-01",
              "name": "[variables('storageAccountName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "accessTier": "Hot",
                "allowBlobPublicAccess": false,
                "allowSharedKeyAccess": true,
                "minimumTlsVersion": "TLS1_2",
                "supportsHttpsTrafficOnly": true,
                "publicNetworkAccess": "Enabled",
                "networkAcls": {
                  "defaultAction": "Allow",
                  "bypass": "AzureServices",
                  "virtualNetworkRules": [],
                  "ipRules": []
                }
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', variables('storageAccountName'), 'default')]",
              "properties": {
                "deleteRetentionPolicy": {
                  "enabled": false
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/queueServices",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', variables('storageAccountName'), 'default')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/fileServices",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', variables('storageAccountName'), 'default')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            }
          ],
          "outputs": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name"
              },
              "value": "[variables('storageAccountName')]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "Storage account resource ID"
              },
              "value": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
            },
            "fileServiceName": {
              "type": "string",
              "metadata": {
                "description": "File service name (for dependency)"
              },
              "value": "default"
            },
            "primaryEndpoints": {
              "type": "object",
              "metadata": {
                "description": "Storage account primary endpoint"
              },
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-05-01').primaryEndpoints]"
            }
          }
        }
      },
      "dependsOn": [
        "resourceGroup"
      ]
    },
    "functionApp": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('functionApp-{0}', uniqueString('functionApp', deployment().name))]",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "baseName": {
            "value": "[parameters('baseName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "uniqueSuffix": {
            "value": "[variables('uniqueSuffix')]"
          },
          "storageAccountName": {
            "value": "[reference('storageAccount').outputs.storageAccountName.value]"
          },
          "storageFileServiceReady": {
            "value": "[reference('storageAccount').outputs.fileServiceName.value]"
          },
          "appInsightsConnectionString": {
            "value": "[reference('appInsights').outputs.connectionString.value]"
          },
          "appInsightsInstrumentationKey": {
            "value": "[reference('appInsights').outputs.instrumentationKey.value]"
          },
          "keyVaultName": {
            "value": "[reference('keyVault').outputs.keyVaultName.value]"
          },
          "cosmosDbEndpoint": {
            "value": "[reference('cosmosDb').outputs.endpoint.value]"
          },
          "cosmosDbDatabaseName": {
            "value": "[reference('cosmosDb').outputs.databaseName.value]"
          },
          "serviceBusNamespace": {
            "value": "[reference('serviceBus').outputs.namespaceName.value]"
          },
          "communicationServicesEndpoint": {
            "value": "[reference('communicationServices').outputs.endpoint.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "3744888367035043996"
            }
          },
          "parameters": {
            "baseName": {
              "type": "string",
              "metadata": {
                "description": "Base name for resources"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name for Functions"
              }
            },
            "storageFileServiceReady": {
              "type": "string",
              "metadata": {
                "description": "File service dependency check"
              }
            },
            "appInsightsConnectionString": {
              "type": "string",
              "metadata": {
                "description": "Application Insights connection string"
              }
            },
            "appInsightsInstrumentationKey": {
              "type": "string",
              "metadata": {
                "description": "Application Insights instrumentation key"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name"
              }
            },
            "cosmosDbEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Cosmos DB endpoint"
              }
            },
            "cosmosDbDatabaseName": {
              "type": "string",
              "metadata": {
                "description": "Cosmos DB database name"
              }
            },
            "serviceBusNamespace": {
              "type": "string",
              "metadata": {
                "description": "Service Bus namespace name"
              }
            },
            "communicationServicesEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Communication Services endpoint"
              }
            },
            "uniqueSuffix": {
              "type": "string",
              "metadata": {
                "description": "Unique suffix for globally unique names"
              }
            }
          },
          "variables": {
            "functionAppName": "[format('func{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix'))]",
            "appServicePlanName": "[format('asp-{0}-{1}', parameters('baseName'), parameters('environment'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-12-01",
              "name": "[variables('appServicePlanName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Y1",
                "tier": "Dynamic",
                "size": "Y1",
                "family": "Y"
              },
              "properties": {
                "reserved": true
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-12-01",
              "name": "[variables('functionAppName')]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject('azd-service-name', 'api'))]",
              "kind": "functionapp,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                "httpsOnly": true,
                "publicNetworkAccess": "Enabled",
                "siteConfig": {
                  "linuxFxVersion": "Node|20",
                  "ftpsState": "Disabled",
                  "minTlsVersion": "1.2",
                  "http20Enabled": true,
                  "cors": {
                    "allowedOrigins": [
                      "https://portal.azure.com",
                      "http://localhost:3000",
                      "http://localhost:5173"
                    ],
                    "supportCredentials": true
                  },
                  "appSettings": [
                    {
                      "name": "AzureWebJobsStorage",
                      "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', parameters('storageAccountName'), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-05-01').keys[0].value)]"
                    },
                    {
                      "name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
                      "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', parameters('storageAccountName'), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-05-01').keys[0].value)]"
                    },
                    {
                      "name": "WEBSITE_CONTENTSHARE",
                      "value": "[toLower(variables('functionAppName'))]"
                    },
                    {
                      "name": "FUNCTIONS_EXTENSION_VERSION",
                      "value": "~4"
                    },
                    {
                      "name": "FUNCTIONS_WORKER_RUNTIME",
                      "value": "node"
                    },
                    {
                      "name": "WEBSITE_NODE_DEFAULT_VERSION",
                      "value": "~20"
                    },
                    {
                      "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                      "value": "[parameters('appInsightsConnectionString')]"
                    },
                    {
                      "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                      "value": "[parameters('appInsightsInstrumentationKey')]"
                    },
                    {
                      "name": "BESTBUY_API_KEY",
                      "value": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=BestBuyApiKey)', parameters('keyVaultName'))]"
                    },
                    {
                      "name": "SMS_PHONE_NUMBER",
                      "value": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=SmsPhoneNumber)', parameters('keyVaultName'))]"
                    },
                    {
                      "name": "COSMOS_ENDPOINT",
                      "value": "[parameters('cosmosDbEndpoint')]"
                    },
                    {
                      "name": "COSMOS_DATABASE_NAME",
                      "value": "[parameters('cosmosDbDatabaseName')]"
                    },
                    {
                      "name": "SERVICE_BUS_NAMESPACE",
                      "value": "[format('{0}.servicebus.windows.net', parameters('serviceBusNamespace'))]"
                    },
                    {
                      "name": "ACS_ENDPOINT",
                      "value": "[format('https://{0}', parameters('communicationServicesEndpoint'))]"
                    },
                    {
                      "name": "ENVIRONMENT",
                      "value": "[parameters('environment')]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
              ]
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Function App name"
              },
              "value": "[variables('functionAppName')]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "Function App resource ID"
              },
              "value": "[resourceId('Microsoft.Web/sites', variables('functionAppName'))]"
            },
            "defaultHostname": {
              "type": "string",
              "metadata": {
                "description": "Function App default hostname"
              },
              "value": "[reference(resourceId('Microsoft.Web/sites', variables('functionAppName')), '2023-12-01').defaultHostName]"
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Function App managed identity principal ID"
              },
              "value": "[reference(resourceId('Microsoft.Web/sites', variables('functionAppName')), '2023-12-01', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "appInsights",
        "communicationServices",
        "cosmosDb",
        "keyVault",
        "resourceGroup",
        "serviceBus",
        "storageAccount"
      ]
    },
    "staticWebApp": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('staticWebApp-{0}', uniqueString('staticWebApp', deployment().name))]",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "baseName": {
            "value": "[parameters('baseName')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "uniqueSuffix": {
            "value": "[variables('uniqueSuffix')]"
          },
          "functionAppHostname": {
            "value": "[reference('functionApp').outputs.defaultHostname.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "5981819999915677409"
            }
          },
          "parameters": {
            "baseName": {
              "type": "string",
              "metadata": {
                "description": "Base name for resources"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "functionAppHostname": {
              "type": "string",
              "metadata": {
                "description": "Function App hostname for API backend"
              }
            },
            "uniqueSuffix": {
              "type": "string",
              "metadata": {
                "description": "Unique suffix for globally unique names"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/staticSites",
              "apiVersion": "2023-12-01",
              "name": "[format('stapp{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix'))]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject('azd-service-name', 'web'))]",
              "sku": {
                "name": "Free",
                "tier": "Free"
              },
              "properties": {
                "stagingEnvironmentPolicy": "Enabled",
                "allowConfigFileUpdates": true,
                "buildProperties": {
                  "appLocation": "/src/web",
                  "apiLocation": "",
                  "outputLocation": "dist",
                  "appBuildCommand": "npm run build"
                }
              }
            },
            {
              "type": "Microsoft.Web/staticSites/linkedBackends",
              "apiVersion": "2023-12-01",
              "name": "[format('{0}/{1}', format('stapp{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix')), 'backend')]",
              "properties": {
                "backendResourceId": "[resourceId('Microsoft.Web/sites', format('func-{0}-{1}', parameters('baseName'), parameters('environment')))]",
                "region": "[parameters('location')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/staticSites', format('stapp{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Web/staticSites/config",
              "apiVersion": "2023-12-01",
              "name": "[format('{0}/{1}', format('stapp{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix')), 'appsettings')]",
              "properties": {
                "API_BASE_URL": "[format('https://{0}/api', parameters('functionAppHostname'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/staticSites', format('stapp{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix')))]"
              ]
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Static Web App name"
              },
              "value": "[format('stapp{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix'))]"
            },
            "resourceId": {
              "type": "string",
              "metadata": {
                "description": "Static Web App resource ID"
              },
              "value": "[resourceId('Microsoft.Web/staticSites', format('stapp{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix')))]"
            },
            "defaultHostname": {
              "type": "string",
              "metadata": {
                "description": "Static Web App default hostname"
              },
              "value": "[reference(resourceId('Microsoft.Web/staticSites', format('stapp{0}{1}{2}', parameters('baseName'), parameters('environment'), parameters('uniqueSuffix'))), '2023-12-01').defaultHostname]"
            }
          }
        }
      },
      "dependsOn": [
        "functionApp",
        "resourceGroup"
      ]
    },
    "roleAssignments": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('roleAssignments-{0}', uniqueString('roleAssignments', deployment().name))]",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "functionAppPrincipalId": {
            "value": "[reference('functionApp').outputs.principalId.value]"
          },
          "keyVaultName": {
            "value": "[reference('keyVault').outputs.keyVaultName.value]"
          },
          "cosmosDbAccountName": {
            "value": "[reference('cosmosDb').outputs.accountName.value]"
          },
          "serviceBusNamespaceName": {
            "value": "[reference('serviceBus').outputs.namespaceName.value]"
          },
          "communicationServicesName": {
            "value": "[reference('communicationServices').outputs.name.value]"
          },
          "storageAccountName": {
            "value": "[reference('storageAccount').outputs.storageAccountName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "282988704493264699"
            }
          },
          "parameters": {
            "functionAppPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Function App managed identity principal ID"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name"
              }
            },
            "cosmosDbAccountName": {
              "type": "string",
              "metadata": {
                "description": "Cosmos DB account name"
              }
            },
            "serviceBusNamespaceName": {
              "type": "string",
              "metadata": {
                "description": "Service Bus namespace name"
              }
            },
            "communicationServicesName": {
              "type": "string",
              "metadata": {
                "description": "Communication Services name"
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name"
              }
            }
          },
          "variables": {
            "keyVaultSecretsUserRoleId": "4633458b-17de-408a-b874-0445c86b69e6",
            "cosmosDbDataContributorRoleId": "00000000-0000-0000-0000-000000000002",
            "serviceBusDataOwnerRoleId": "090c5cfd-751d-490a-894a-3ce6f1109419",
            "storageBlobDataContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('functionAppPrincipalId'), variables('keyVaultSecretsUserRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('keyVaultSecretsUserRoleId'))]",
                "principalId": "[parameters('functionAppPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusNamespaceName'))]",
              "name": "[guid(resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusNamespaceName')), parameters('functionAppPrincipalId'), variables('serviceBusDataOwnerRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('serviceBusDataOwnerRoleId'))]",
                "principalId": "[parameters('functionAppPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('functionAppPrincipalId'), variables('storageBlobDataContributorRoleId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRoleId'))]",
                "principalId": "[parameters('functionAppPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
              "apiVersion": "2024-05-15",
              "name": "[format('{0}/{1}', parameters('cosmosDbAccountName'), guid(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName')), parameters('functionAppPrincipalId'), variables('cosmosDbDataContributorRoleId')))]",
              "properties": {
                "roleDefinitionId": "[format('{0}/sqlRoleDefinitions/{1}', resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName')), variables('cosmosDbDataContributorRoleId'))]",
                "principalId": "[parameters('functionAppPrincipalId')]",
                "scope": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName'))]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "communicationServices",
        "cosmosDb",
        "functionApp",
        "keyVault",
        "resourceGroup",
        "serviceBus",
        "storageAccount"
      ]
    }
  },
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "Resource group name"
      },
      "value": "[variables('resourceGroupName')]"
    },
    "functionAppHostname": {
      "type": "string",
      "metadata": {
        "description": "Function App hostname"
      },
      "value": "[reference('functionApp').outputs.defaultHostname.value]"
    },
    "staticWebAppHostname": {
      "type": "string",
      "metadata": {
        "description": "Static Web App hostname"
      },
      "value": "[reference('staticWebApp').outputs.defaultHostname.value]"
    },
    "keyVaultName": {
      "type": "string",
      "metadata": {
        "description": "Key Vault name"
      },
      "value": "[reference('keyVault').outputs.keyVaultName.value]"
    },
    "cosmosDbEndpoint": {
      "type": "string",
      "metadata": {
        "description": "Cosmos DB endpoint"
      },
      "value": "[reference('cosmosDb').outputs.endpoint.value]"
    },
    "appInsightsConnectionString": {
      "type": "string",
      "metadata": {
        "description": "Application Insights connection string"
      },
      "value": "[reference('appInsights').outputs.connectionString.value]"
    }
  }
}